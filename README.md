<div align="center">
  <img src="docs/assets/logo.svg" alt="CitySense Logo" width="320"/>

  <h1>CitySense</h1>

  <p><b>Geospatial RAG + MCP Toolkit for Urban Intelligence</b></p>
  <p><sub>Built for SDG 11 workflows, pilot countries, and research-grade city analytics.</sub></p>

  <p><sub><b>QUICK LINKS</b></sub></p>
  <p>
    <a href="https://citysense.readthedocs.io">Documentation</a> |
    <a href="https://pypi.org/project/citysense/">PyPI</a> |
    <a href="https://github.com/olaflaitinen/citysense/issues">Issues</a> |
    <a href="https://modelcontextprotocol.io/">MCP</a>
  </p>

  <!-- Partner Logos -->
  <p>
    <sub><b>PARTNERS</b></sub><br>
    <img src="docs/assets/partners/unh_sqr_logo.svg" alt="UN-Habitat Logo" height="34"/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    <img src="docs/assets/partners/wuf-logo.svg" alt="World Urban Forum Logo" height="34"/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    <img src="docs/assets/partners/arxkom_logo_en.svg" alt="Arxkom Logo" height="34"/>
  </p>

  <!-- Mini Flags -->
  <p>
    <sub><b>PILOT COUNTRIES</b></sub><br>
    <img src="https://flagcdn.com/16x12/az.png" alt="Azerbaijan flag" width="16" height="12"/> <sub>AZ</sub>&nbsp;&nbsp;
    <img src="https://flagcdn.com/16x12/fi.png" alt="Finland flag" width="16" height="12"/> <sub>FI</sub>&nbsp;&nbsp;
    <img src="https://flagcdn.com/16x12/se.png" alt="Sweden flag" width="16" height="12"/> <sub>SE</sub>&nbsp;&nbsp;
    <img src="https://flagcdn.com/16x12/dk.png" alt="Denmark flag" width="16" height="12"/> <sub>DK</sub>&nbsp;&nbsp;
    <img src="https://flagcdn.com/16x12/no.png" alt="Norway flag" width="16" height="12"/> <sub>NO</sub>
  </p>

  <br>

  <!-- Project Status & PyPI -->
  <p><sub><b>PACKAGE</b></sub></p>
  <p>
    <a href="https://pypi.org/project/citysense/"><img src="https://img.shields.io/pypi/v/citysense?logo=pypi&logoColor=white&style=flat&cacheSeconds=3600" alt="PyPI version"></a>
    <a href="https://pypi.org/project/citysense/"><img src="https://img.shields.io/pypi/pyversions/citysense?logo=python&logoColor=white&style=flat&cacheSeconds=3600" alt="PyPI - Python Version"></a>
    <a href="https://pypi.org/project/citysense/"><img src="https://img.shields.io/pypi/wheel/citysense?logo=pypi&logoColor=white&style=flat&cacheSeconds=3600" alt="PyPI - Wheel"></a>
    <a href="https://pypi.org/project/citysense/"><img src="https://img.shields.io/pypi/format/citysense?logo=pypi&logoColor=white&style=flat&cacheSeconds=3600" alt="PyPI - Format"></a>
    <a href="https://pypi.org/project/citysense/"><img src="https://img.shields.io/pypi/status/citysense?logo=pypi&logoColor=white&style=flat&cacheSeconds=3600" alt="PyPI - Status"></a>
    <a href="https://pepy.tech/projects/citysense"><img src="https://static.pepy.tech/badge/citysense/month" alt="PyPI - Downloads"></a>
  </p>

  <!-- GitHub Stats -->
  <p><sub><b>REPOSITORY</b></sub></p>
  <p>
    <a href="https://github.com/olaflaitinen/citysense/stargazers"><img src="https://img.shields.io/github/stars/olaflaitinen/citysense?logo=github&logoColor=white&style=flat&cacheSeconds=3600" alt="GitHub stars"></a>
    <a href="https://github.com/olaflaitinen/citysense/network/members"><img src="https://img.shields.io/github/forks/olaflaitinen/citysense?logo=github&logoColor=white&style=flat&cacheSeconds=3600" alt="GitHub forks"></a>
    <a href="https://github.com/olaflaitinen/citysense/issues"><img src="https://img.shields.io/github/issues/olaflaitinen/citysense?logo=github&logoColor=white&style=flat&cacheSeconds=3600" alt="GitHub issues"></a>
    <a href="https://github.com/olaflaitinen/citysense/issues?q=is%3Aissue+is%3Aclosed"><img src="https://img.shields.io/github/issues-closed/olaflaitinen/citysense?logo=github&logoColor=white&style=flat&cacheSeconds=3600" alt="GitHub issues closed"></a>
    <a href="https://github.com/olaflaitinen/citysense/pulls"><img src="https://img.shields.io/github/issues-pr/olaflaitinen/citysense?logo=github&logoColor=white&style=flat&cacheSeconds=3600" alt="GitHub PRs"></a>
    <a href="https://github.com/olaflaitinen/citysense/pulls?q=is%3Apr+is%3Aclosed"><img src="https://img.shields.io/github/issues-pr-closed/olaflaitinen/citysense?logo=github&logoColor=white&style=flat&cacheSeconds=3600" alt="GitHub PRs closed"></a>
    <a href="https://github.com/olaflaitinen/citysense/graphs/contributors"><img src="https://img.shields.io/github/contributors/olaflaitinen/citysense?logo=github&logoColor=white&style=flat&cacheSeconds=3600" alt="GitHub contributors"></a>
    <a href="https://github.com/olaflaitinen/citysense/commits/main"><img src="https://img.shields.io/github/last-commit/olaflaitinen/citysense?logo=github&logoColor=white&style=flat&cacheSeconds=3600" alt="GitHub last commit"></a>
    <a href="https://github.com/olaflaitinen/citysense/commits/main"><img src="https://img.shields.io/github/commit-activity/m/olaflaitinen/citysense?logo=github&logoColor=white&style=flat&cacheSeconds=3600" alt="GitHub commit activity"></a>
    <a href="https://github.com/olaflaitinen/citysense"><img src="https://img.shields.io/github/languages/code-size/olaflaitinen/citysense?logo=github&logoColor=white&style=flat&cacheSeconds=3600" alt="Code size"></a>
    <a href="https://github.com/olaflaitinen/citysense"><img src="https://img.shields.io/github/languages/top/olaflaitinen/citysense?logo=python&logoColor=white&style=flat&cacheSeconds=3600" alt="Top language"></a>
    <a href="https://github.com/olaflaitinen/citysense"><img src="https://img.shields.io/github/repo-size/olaflaitinen/citysense?logo=github&logoColor=white&style=flat&cacheSeconds=3600" alt="Repo size"></a>
  </p>

  <!-- CI/CD & Quality -->
  <p><sub><b>QUALITY</b></sub></p>
  <p>
    <a href="https://github.com/olaflaitinen/citysense/actions/workflows/ci.yml"><img src="https://img.shields.io/github/actions/workflow/status/olaflaitinen/citysense/ci.yml?branch=main&label=CI&logo=githubactions&logoColor=white&style=flat&cacheSeconds=3600" alt="CI"></a>
    <a href="https://github.com/olaflaitinen/citysense/actions/workflows/scorecard-analysis.yml"><img src="https://img.shields.io/github/actions/workflow/status/olaflaitinen/citysense/scorecard-analysis.yml?branch=main&label=Scorecard&logo=githubactions&logoColor=white&style=flat&cacheSeconds=3600" alt="Scorecard CI"></a>
    <a href="https://codecov.io/gh/olaflaitinen/citysense"><img src="https://img.shields.io/codecov/c/github/olaflaitinen/citysense?logo=codecov&logoColor=white&style=flat&cacheSeconds=3600" alt="Codecov"></a>
    <a href="https://scorecard.dev/viewer/?uri=github.com/olaflaitinen/citysense"><img src="https://img.shields.io/badge/dynamic/json?url=https://api.scorecard.dev/projects/github.com/olaflaitinen/citysense&query=$.score&label=OpenSSF%20Scorecard&suffix=%2F10&logo=securityscorecard&logoColor=white&style=flat&cacheSeconds=3600" alt="OpenSSF Scorecard"></a>
    <a href="https://app.deepsource.com/gh/olaflaitinen/citysense/?ref=repository-badge"><img alt="DeepSource" title="DeepSource" src="https://app.deepsource.com/gh/olaflaitinen/citysense.svg/?label=active+issues&show_trend=true"></a>
    <a href="https://opensource.org/licenses/EUPL-1.2"><img src="https://img.shields.io/badge/license-EUPL--1.2-green?logo=europeanunion&logoColor=white&style=flat&cacheSeconds=3600" alt="License"></a>
  </p>

  <!-- Code Style & Standards -->
  <p><sub><b>STANDARDS</b></sub></p>
  <p>
    <a href="https://docs.astral.sh/ruff/"><img src="https://img.shields.io/endpoint?url=https://raw.githubusercontent.com/astral-sh/ruff/main/assets/badge/v2.json&style=flat&cacheSeconds=3600" alt="Ruff"></a>
    <a href="https://github.com/psf/black"><img src="https://img.shields.io/badge/code%20style-black-000000.svg?logo=black&logoColor=white&style=flat&cacheSeconds=3600" alt="Code style: black"></a>
    <a href="https://mypy-lang.org/"><img src="https://img.shields.io/badge/type%20checker-mypy-2a6db2.svg?logo=python&logoColor=white&style=flat&cacheSeconds=3600" alt="mypy"></a>
    <a href="https://pycqa.github.io/isort/"><img src="https://img.shields.io/badge/imports-isort-1674B1?logo=pycqa&logoColor=white&style=flat&cacheSeconds=3600" alt="isort"></a>
    <a href="https://pre-commit.com/"><img src="https://img.shields.io/badge/pre--commit-enabled-brightgreen?logo=precommit&logoColor=white&style=flat&cacheSeconds=3600" alt="Pre-commit"></a>
    <a href="https://github.com/editorconfig/editorconfig"><img src="https://img.shields.io/badge/EditorConfig-enabled-cyan?logo=editorconfig&logoColor=white&style=flat&cacheSeconds=3600" alt="EditorConfig"></a>
    <a href="https://pypi.org/project/bandit/"><img src="https://img.shields.io/badge/security-bandit-F29F05?logo=pycqa&logoColor=white&style=flat&cacheSeconds=3600" alt="Security: bandit"></a>
  </p>

  <!-- Tech Stack -->
  <p><sub><b>TECH STACK</b></sub></p>
  <p>
    <a href="https://modelcontextprotocol.io/"><img src="https://img.shields.io/badge/Protocol-MCP-6366F1?logo=modelcontextprotocol&logoColor=white&style=flat" alt="MCP"></a>
    <a href="https://sdgs.un.org/goals/goal11"><img src="https://img.shields.io/badge/UN--SDG-11-009EDB?logo=unitednations&logoColor=white&style=flat" alt="SDG 11"></a>
    <a href="https://www.openstreetmap.org/"><img src="https://img.shields.io/badge/Data-OpenStreetMap-7EBC6F?logo=openstreetmap&logoColor=white&style=flat" alt="OpenStreetMap"></a>
    <a href="https://www.mapillary.com/"><img src="https://img.shields.io/badge/Data-Mapillary-05CB63?logo=mapillary&logoColor=white&style=flat" alt="Mapillary"></a>
    <a href="https://sentinel.esa.int/"><img src="https://img.shields.io/badge/Data-Sentinel--2-4B6A9C?logo=data%3Aimage%2Fsvg%2Bxml%3Bbase64%2CPD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8%2BIDwhLS0gQ3JlYXRlZCB3aXRoIElua3NjYXBlIChodHRwOi8vd3d3Lmlua3NjYXBlLm9yZy8pIC0tPiA8c3ZnIHhtbG5zOnN2Zz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgdmVyc2lvbj0iMS4wIiB3aWR0aD0iMjQyLjg4NjA2IiBoZWlnaHQ9IjI0Mi45NzUxMyIgaWQ9InN2ZzI0MjkiPiAgIDxkZWZzIGlkPSJkZWZzMjQzMSIvPiAgIDxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKC0yODQuMzQ1MjksLTMxMC44NzQ2MikiIGlkPSJsYXllcjEiPiAgICAgPHBhdGggZD0iTSA0NDEuMjc2NTYsNDIxLjY5MDkxIEwgNDg5LjA2ODUxLDQyMS42OTA5MSBDIDQ4OS4wNjg1MSw0MjEuNjkwOTEgNDkwLjk1OTQyLDQxNC41MDY0NyA0ODIuNDQ4LDQwMy43MzU1NiBDIDQ2NS42MzU3OCwzODYuMzYyNDUgNDQ2Ljc1MDk2LDM5Ny44ODQyNSA0NDYuNzUwOTYsMzk3Ljg4NDI1IEMgNDM3LjQ5MDk3LDQwMi43OTQ2NiA0MjUuNTk4MjcsNDIzLjE5OTUxIDQzMi41NzUyLDQ1Mi40ODA1NyBDIDQ0MS4yNzY1Niw0ODEuNzY3NzcgNDc0LjcwODAyLDQ4Ny43OTQ0NCA0OTUuNDgwNyw0ODAuOTk1OSBDIDUwOS4yMjkzNSw0NzYuNDk4MTUgNTE3LjE1NjI4LDQ2Ni41ODI1OCA1MjAuOTcwODIsNDYwLjM2MjY0IEMgNTIyLjE5NzQ5LDQ1NS4zMzA2MiA1MjMuMDczMDIsNDUwLjI5ODU0IDUyMy42MjQ3OSw0NDUuMjk2MTMgTCA0NDEuMjc2NTYsNDQ1LjI5NjEzIEwgNDQxLjI3NjU2LDQyMS42OTA5MSB6IiBpZD0icGF0aDI0MjUiIHN0eWxlPSJmaWxsOiMwMDMyNDc7ZmlsbC1vcGFjaXR5OjE7ZmlsbC1ydWxlOm5vbnplcm87c3Ryb2tlOm5vbmUiLz4gICAgIDxwYXRoIHN0eWxlPSJmaWxsOiMwMDMyNDc7ZmlsbC1vcGFjaXR5OjE7ZmlsbC1ydWxlOm5vbnplcm87c3Ryb2tlOm5vbmUiIGlkPSJwYXRoMjQyMyIgZD0iTSAzOTkuNTAzMTMsMzE0LjA0ODQgQyAzNDkuMDcxNDQsMzE2LjczMDg4IDMwNC4wNzc5MiwzNTEuNjMzNjEgMjkxLjAxMTIzLDQwMy4xNTk5NiBDIDI3NC45MjMyNiw0NjYuNTgyMjggMzEzLjI4NjI0LDUzMS4wOTE1NCAzNzYuNzAyNzMsNTQ3LjE4MjQ4IEMgNDIxLjc2MDE1LDU1OC42MTIzIDQ2Ny40NDk4NCw1NDIuNTYwMDggNDk1LjgzNDgyLDUwOS41NjE4MyBDIDQ4My4zNTM4Nyw1MTIuNTQ1NDYgNDY4Ljc0NzIxLDUxMi43NDQ0IDQ1Mi44OTQwNiw1MDcuMjgxNzkgQyAzOTkuODAzMzYsNDg4Ljk0OTQxIDM5MC4wNzQ0LDQzOS44MTkxNyA0MDMuMzAzMTksNDA1LjQ0IEMgNDE2LjUxNDUzLDM3MS4wNTg1MiA0NjIuNzc0MjMsMzU1LjAzMjg4IDQ5NC44ODQ4LDM3OC4wNzk1MiBDIDUyMi40MDY1OCwzOTcuODE3ODYgNTIzLjkxODQ2LDQzMi45ODUyNSA1MjMuNzY1Myw0NDIuNjgwNjUgQyA1MjguODMwMDksMzg1Ljc4NjQyIDQ5Mi4xNzg4NSwzMzEuOTc2OTkgNDM1LjAzMzc0LDMxNy40Njg0NiBDIDQyMy4xNDMyNCwzMTQuNDUzMDkgNDExLjE0MTI0LDMxMy40MjkzOSAzOTkuNTAzMTMsMzE0LjA0ODQgeiBNIDM0MS43NDIxMSw0MTguNTUwMjMgQyAzNTAuMTYxNjYsNDE4LjU1MDIzIDM1Ni45NDIzOCw0MjUuMzM2MzUgMzU2Ljk0MjM4LDQzMy43NTA1IEMgMzU2Ljk0MjM4LDQ0Mi4xNjk5MiAzNTAuMTYxNjYsNDQ4Ljk1MDc2IDM0MS43NDIxMSw0NDguOTUwNzYgQyAzMzMuMzI4NTksNDQ4Ljk1MDc2IDMyNi4zNTE4NCw0NDIuMTY5OTIgMzI2LjM1MTg0LDQzMy43NTA1IEMgMzI2LjM1MTkxLDQyNS4zMzYzNSAzMzMuMzI4NTksNDE4LjU1MDIzIDM0MS43NDIxMSw0MTguNTUwMjMgeiIvPiAgIDwvZz4gPC9zdmc%2B&logoColor=white&style=flat" alt="Sentinel-2"></a>
    <a href="https://qdrant.tech/"><img src="https://img.shields.io/badge/Vector%20Store-Qdrant-DC244C?logo=data%3Aimage%2Fsvg%2Bxml%3Bbase64%2CPHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxNzMuMjEgMjAwIj4KICA8cG9seWdvbiBmaWxsPSIjREMyNDRDIiBwb2ludHM9Ijg2LjYgMCAwIDUwIDAgMTUwIDg2LjYgMjAwIDExOS4wOCAxODEuMjUgMTE5LjA4IDE0My43NSA4Ni42IDE2Mi41IDMyLjQ4IDEzMS4yNSAzMi40OCA2OC43NSA4Ni42IDM3LjUgMTQwLjczIDY4Ljc1IDE0MC43MyAxOTMuNzUgMTczLjIxIDE3NSAxNzMuMjEgNTAgODYuNiAwIi8%2BCiAgPHBvbHlnb24gZmlsbD0iIzlFMEQzOCIgcG9pbnRzPSIxMTkuMDggMTQzLjc1IDExOS4wOCAxODEuMjUgODYuNiAyMDAgODYuNiAxNjIuNSAxMTkuMDggMTQzLjc1Ii8%2BCiAgPHBvbHlnb24gZmlsbD0iIzlFMEQzOCIgcG9pbnRzPSIxNzMuMjEgNTAgMTczLjIxIDE3NSAxNDAuNzMgMTkzLjc1IDE0MC43MyA2OC43NSAxNzMuMjEgNTAiLz4KICA8cG9seWdvbiBmaWxsPSIjRkY1MTZCIiBwb2ludHM9IjE3My4yMSA1MCAxNDAuNzMgNjguNzUgODYuNiAzNy41IDMyLjQ4IDY4Ljc1IDAgNTAgODYuNiAwIDE3My4yMSA1MCIvPgogIDxwb2x5Z29uIGZpbGw9IiNEQzI0NEMiIHBvaW50cz0iODYuNiAxNjIuNSA4Ni42IDIwMCAwIDE1MCAwIDUwIDMyLjQ4IDY4Ljc1IDMyLjQ4IDEzMS4yNSA4Ni42IDE2Mi41Ii8%2BCiAgPHBvbHlnb24gZmlsbD0iI0ZGNTE2QiIgcG9pbnRzPSIxMTkuMDggODEuMjUgODYuNiAxMDAgNTQuMTMgODEuMjUgODYuNiA2Mi41IDExOS4wOCA4MS4yNSIvPgogIDxwb2x5Z29uIGZpbGw9IiNEQzI0NEMiIHBvaW50cz0iODYuNiAxMDAgODYuNiAxMzcuNSA1NC4xMyAxMTguNzUgNTQuMTMgODEuMjUgODYuNiAxMDAiLz4KICA8cG9seWdvbiBmaWxsPSIjOUUwRDM4IiBwb2ludHM9IjExOS4wOCA4MS4yNSAxMTkuMDggMTE4Ljc1IDg2LjYgMTM3LjUgODYuNiAxMDAgMTE5LjA4IDgxLjI1Ii8%2BCjwvc3ZnPg%3D%3D&style=flat" alt="Qdrant"></a>
    <a href="https://shapely.readthedocs.io/"><img src="https://img.shields.io/badge/Geometry-Shapely%202.1%2B-3776AB?logo=python&logoColor=white&style=flat" alt="Shapely"></a>
    <a href="https://geopandas.org/"><img src="https://img.shields.io/badge/Geospatial-GeoPandas%201.1%2B-3776AB?logo=geopandas&logoColor=white&style=flat" alt="GeoPandas"></a>
    <a href="https://numpy.org/"><img src="https://img.shields.io/badge/Compute-NumPy-013243?logo=numpy&logoColor=white&style=flat" alt="NumPy"></a>
    <a href="https://pandas.pydata.org/"><img src="https://img.shields.io/badge/Data-Pandas-150458?logo=pandas&logoColor=white&style=flat" alt="Pandas"></a>
    <a href="https://pydantic.dev/"><img src="https://img.shields.io/badge/Validation-Pydantic-E92063?logo=pydantic&logoColor=white&style=flat" alt="Pydantic"></a>
    <a href="https://h3geo.org/"><img src="https://img.shields.io/badge/Index-H3-FFFF00?logo=h3&logoColor=black&style=flat" alt="H3"></a>
  </p>
  
  <!-- OS & Platform -->
  <p><sub><b>PLATFORM</b></sub></p>
  <p>
    <a href="https://ubuntu.com/"><img src="https://img.shields.io/badge/OS-Linux-FCC624?logo=linux&logoColor=black&style=flat" alt="Linux"></a>
    <a href="https://www.apple.com/macos/"><img src="https://img.shields.io/badge/OS-macOS-000000?logo=macos&logoColor=white&style=flat" alt="macOS"></a>
    <a href="https://www.microsoft.com/windows/"><img src="https://img.shields.io/badge/OS-Windows-0078D6?logo=data%3Aimage%2Fsvg%2Bxml%3Bbase64%2CPHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iODgiIHdpZHRoPSI4OCIgeG1sbnM6dj0iaHR0cHM6Ly92ZWN0YS5pby9uYW5vIj48cGF0aCBkPSJNMCAxMi40MDJsMzUuNjg3LTQuODYuMDE2IDM0LjQyMy0zNS42Ny4yMDN6bTM1LjY3IDMzLjUyOWwuMDI4IDM0LjQ1M0wuMDI4IDc1LjQ4TC4wMjYgNDUuN3ptNC4zMjYtMzkuMDI1TDg3LjMxNCAwdjQxLjUyN2wtNDcuMzE4LjM3NnptNDcuMzI5IDM5LjM0OWwtLjAxMSA0MS4zNC00Ny4zMTgtNi42NzgtLjA2Ni0zNC43Mzl6IiBmaWxsPSIjMDBhZGVmIi8%2BPC9zdmc%2B&logoColor=white&style=flat" alt="Windows"></a>
    <a href="https://hub.docker.com/r/olaflaitinen/citysense"><img src="https://img.shields.io/badge/Container-Docker-2496ED?logo=docker&logoColor=white&style=flat" alt="Docker"></a>
    <a href="https://conda.io/"><img src="https://img.shields.io/badge/Env-Conda-44A833?logo=anaconda&logoColor=white&style=flat" alt="Conda"></a>
  </p>
</div>

---

## Table of Contents

- [Abstract](#abstract)
- [Executive Summary](#executive-summary)
- [Overview](#overview)
- [Current Implementation Status](#current-implementation-status)
- [Architecture](#architecture)
- [Requirements](#requirements)
- [Installation](#installation)
- [Quick Start](#quick-start)
- [Configuration](#configuration)
- [CLI Reference](#cli-reference)
- [MCP Integration](#mcp-integration)
- [Known Limitations](#known-limitations)
- [Pilot Countries](#pilot-countries)
- [Mathematical Foundations](#mathematical-foundations)
- [API Summary](#api-summary)
- [Data Sources and Connectors](#data-sources-and-connectors)
- [WUF13 Alignment](#wuf13-alignment)
- [H3 Spatial Index](#h3-spatial-index)
- [Dependencies](#dependencies)
- [Data Flow](#data-flow)
- [Troubleshooting](#troubleshooting)
- [Glossary](#glossary)
- [Frequently Asked Questions](#frequently-asked-questions)
- [Version History](#version-history)
- [Development](#development)
- [Security Considerations](#security-considerations)
- [Performance Notes](#performance-notes)
- [References](#references)
- [License](#license)
- [Links](#links)
- [Acknowledgments](#acknowledgments)

---

## Abstract

CitySense is an open-source Python library for geospatial retrieval-augmented generation (RAG) and MCP-based AI tooling for urban analysis. It combines natural-language intent parsing, geospatial indexing, and an MCP server so applications can query urban context with minimal boilerplate. The project aligns with SDG 11, the New Urban Agenda, and WUF13 framing. The current codebase includes active pilot configs for Azerbaijan and Finland, OSM-powered indexing, and modular connectors for Sentinel-2, Mapillary, and KartaView integrations.

---

## Executive Summary

| Aspect | Description |
|--------|-------------|
| Primary function | Semantic geospatial retrieval and MCP server for urban AI |
| Target users | Urban AI developers, smart city researchers, policy tool builders |
| Core technologies | Python 3.12+, Qdrant, Shapely, GeoPandas, H3, FastEmbed, FastMCP |
| Implemented pilots | Azerbaijan (`az`), Finland (`fi`) |
| Current indexing path | OSM -> H3 -> embeddings -> Qdrant |
| Standards alignment | WUF13 framing, SDG 11 indicator support |
| License | EUPL-1.2 |

---

## Overview

### Design Philosophy

The core design philosophy of CitySense is that a developer should be able to express spatial intent in natural language and receive structured geospatial results without writing spatial query code. For example:

```python
# find housing zones with low resilience scores near transit corridors in Baku
```

CitySense resolves such intent into structured geospatial results drawn from live and indexed sources.

### Observational Layers

CitySense adds a third observational layer on top of traditional vector geospatial data:

| Layer | Source | Purpose |
|-------|--------|---------|
| Vector | OpenStreetMap, national registers | Buildings, roads, land use, amenities |
| Street-level imagery | Mapillary API v4, KartaView REST API | Ground truth, validation |
| Satellite | Copernicus Data Space, Sentinel Hub | Spectral indices, change detection |

### Key Features

| Capability | Description |
|------------|-------------|
| Natural language queries | Intent parsing and semantic retrieval over geospatial knowledge bases |
| Multi-source architecture | OSM active CLI path; Sentinel-2, Mapillary, and KartaView connector modules included |
| MCP integration | Native Model Context Protocol server for Cursor, Claude, VS Code |
| WUF13 alignment | Pilot-aware schema and indicator model aligned to WUF13 framing |
| SDG 11 metrics | Land consumption rate (11.3.1), urban resilience composite score |
| Spectral indices | NDVI, NDWI, NDBI, EVI, MNDWI, BSI from Sentinel-2 L2A |
| Reciprocal Rank Fusion | Hybrid dense and sparse retrieval with configurable parameter k |

### Primary User Groups

| Group | Use Case |
|-------|----------|
| Urban AI Developers | Build applications on city data with semantic access to geospatial knowledge bases |
| Smart City Researchers | Query, compare, and analyze datasets across multiple countries with consistent schemas |
| Urban Policy Tools Builders | Prototype AI-assisted planning tools aligned with UN New Urban Agenda, SDG 11, and WUF13 |

---

## Current Implementation Status

| Area | Status | Notes |
|------|--------|-------|
| CLI commands | Implemented | `pilot`, `index`, `query`, `serve`, `--version` |
| MCP tools | Implemented | `query_spatial_context` tool is available |
| Indexing connectors in CLI | Partially implemented | `index build` currently uses OSM connector path |
| Pilot country configs | Implemented | `az`, `fi` in `citysense.pilot` |
| Additional pilot profiles | Planned | `se`, `dk`, `no` are parsed in intent logic but not yet shipped as pilot configs |
| SSE transport | Placeholder | `serve --transport sse` currently prints status message |

---

## Architecture

### System Stack

```text
+----------------------------------------------------------------------------------+
|                                 CitySense Stack                                  |
+------------------------------+---------------------------------------------------+
| CLI                          | RAG pipeline                                      |
| - pilot (init/status)        | parse_intent -> embed_texts -> hybrid_search ->  |
| - index (build/status)       | rerank -> assemble_context                       |
| - query                      |                                                   |
| - serve (stdio, sse stub)    |                                                   |
+------------------------------+---------------------------------------------------+
| MCP server (FastMCP)         | Connectors                                        |
| - query_spatial_context      | OSM (active path), Sentinel-2, Mapillary,        |
|                              | KartaView (module-level support)                 |
+------------------------------+---------------------------------------------------+
| Storage and geo foundation: Qdrant + H3 + Shapely + GeoPandas                   |
+----------------------------------------------------------------------------------+
```

### Module Structure

| Module | Responsibility |
|--------|----------------|
| citysense.cli | Typer-based command-line interface |
| citysense.core | Configuration, session, logging, registry, exceptions |
| citysense.geo | CRS, H3, bbox, geometry, OSM utilities |
| citysense.connectors | OSM, Mapillary, KartaView, Sentinel, base connector |
| citysense.rag | Intent parsing, retriever, embedder, reranker, assembler |
| citysense.imagery | Street and satellite processing |
| citysense.housing | Housing analytics primitives |
| citysense.governance | Governance-related scoring hooks |
| citysense.urban | SDG 11 indicators |
| citysense.climate | Resilience scoring |
| citysense.realtime | Realtime stream utilities |
| citysense.pilot | Country-specific configurations |
| citysense.mcp | MCP server and tools |

### Design Principles

| Principle | Implementation |
|-----------|----------------|
| Schema consistency | Pilot configs enforce national CRS and normalised GeoDataFrame schema |
| Extensibility | Connector and pilot registries allow plug-in modules |
| Observability | structlog for structured logging; configurable log levels |
| Type safety | mypy strict mode; Pydantic for config and data validation |

---

## Requirements

| Requirement | Version |
|--------------|---------|
| Python | 3.12 or 3.13 |
| Qdrant | Default endpoint http://localhost:6333 |
| GDAL | 3.10+ (for rasterio, geopandas; conda recommended) |

---

## Installation

### pip

```bash
pip install citysense
```

### Optional Extras

| Extra | Purpose |
|-------|---------|
| clip | CLIP ViT-B/32 for street imagery embedding |
| sentinelhub | Sentinel Hub Process API |
| dev | ruff, mypy, pytest, mkdocs, pre-commit |

```bash
pip install "citysense[clip]"
pip install "citysense[dev]"
```

### conda-forge (Binary Compatibility)

For binary compatibility with GDAL, PROJ, GEOS:

```bash
conda env create -f environment.yml
conda activate citysense
pip install -e ".[dev]"
```

### Editable Install

```bash
git clone https://github.com/olaflaitinen/citysense.git
cd citysense
pip install -e ".[dev]"
```

---

## Quick Start

### 5-Minute Workflow

```bash
# 1) select pilot
citysense pilot init fi

# 2) build index (current CLI path: OSM)
citysense index build --city Helsinki --country fi --sources osm

# 3) check index status
citysense index status --country fi

# 4) run a natural-language query
citysense query "social housing zones within 1 km of metro stations in Helsinki"

# 5) start MCP server (stdio)
citysense serve --transport stdio
```

### Optional: Enable Imagery Dependencies (Connector Modules)

```bash
pip install "citysense[clip]"
pip install "citysense[sentinelhub]"
```

Then set connector credentials (`MAPILLARY_ACCESS_TOKEN`, `CDSE_CLIENT_ID`, `CDSE_CLIENT_SECRET`) as needed.

---

## Configuration

Configuration is read in priority order: environment variables (prefix `CITYSENSE_`), `.env` file at project root, defaults.

### Environment Variables

| Variable | Default | Description |
|----------|---------|-------------|
| CITYSENSE_PILOT_COUNTRY | None | Pilot key (`az`, `fi` fully available; `se`, `dk`, `no` reserved for upcoming profiles) |
| CITYSENSE_VECTOR_STORE_URL | http://localhost:6333 | Qdrant URL |
| CITYSENSE_EMBEDDING_MODEL | BAAI/bge-m3 | Text embedding model |
| MAPILLARY_ACCESS_TOKEN | None | Mapillary API token |
| CDSE_CLIENT_ID | None | Copernicus Data Space client ID |
| CDSE_CLIENT_SECRET | None | Copernicus Data Space client secret |

### Example .env

```
CITYSENSE_PILOT_COUNTRY=fi
CITYSENSE_VECTOR_STORE_URL=http://localhost:6333
MAPILLARY_ACCESS_TOKEN=your_token
CDSE_CLIENT_ID=your_id
CDSE_CLIENT_SECRET=your_secret
```

---

## CLI Reference

| Command | Description |
|---------|-------------|
| citysense --version | Print package version |
| citysense pilot init &lt;country&gt; | Initialize pilot country in `.env` (`az`, `fi`, `se`, `dk`, `no`) |
| citysense pilot status | Show active pilot country |
| citysense index build --city &lt;name&gt; [--country &lt;iso2&gt;] | Build index for selected city |
| citysense index status [--country &lt;iso2&gt;] | Show Qdrant collection point count |
| citysense query &lt;natural language&gt; [--country &lt;iso2&gt;] [--city &lt;name&gt;] | Execute semantic spatial query |
| citysense serve --transport stdio | Start FastMCP server for local MCP clients |
| citysense serve --transport sse --port 7832 | SSE transport placeholder (status output) |

Notes:
- `index build` currently uses the OSM connector path.
- `--sources` is present for forward compatibility and not fully wired yet.
- `index build` city routing is currently optimized for Helsinki and Baku.

### CLI Examples

```bash
# Initialize Finland pilot
citysense pilot init fi

# Show current pilot status
citysense pilot status

# Build index for Helsinki (OSM path)
citysense index build --city Helsinki --country fi --sources osm

# Check index status in Qdrant
citysense index status --country fi

# Query with natural language
citysense query "metro stations within 500m of parks in Helsinki"

# Start MCP server for Cursor/Claude
citysense serve --transport stdio

# SSE transport status output (placeholder)
citysense serve --transport sse
```

---

## MCP Integration

### Cursor

Add to `.cursor/mcp.json`:

```json
{
  "mcpServers": {
    "citysense": {
      "command": "citysense",
      "args": ["serve", "--transport", "stdio"],
      "env": {
        "CITYSENSE_PILOT_COUNTRY": "fi",
        "CITYSENSE_VECTOR_STORE_URL": "http://localhost:6333",
        "MAPILLARY_ACCESS_TOKEN": "your_token",
        "CDSE_CLIENT_ID": "your_id",
        "CDSE_CLIENT_SECRET": "your_secret"
      }
    }
  }
}
```

### Claude Desktop

Add to `claude_desktop_config.json`:

```json
{
  "mcpServers": {
    "citysense": {
      "command": "citysense",
      "args": ["serve", "--transport", "stdio"],
      "env": {
        "CITYSENSE_PILOT_COUNTRY": "az",
        "CITYSENSE_VECTOR_STORE_URL": "http://localhost:6333"
      }
    }
  }
}
```

### Prerequisites

1. Qdrant running at configured URL
2. Index built: `citysense index build --city Helsinki --sources osm`
3. Optional tokens for Mapillary and CDSE if imagery connectors are enabled

### MCP Tools

| Tool | Description |
|------|-------------|
| query_spatial_context | Execute natural language spatial query and return GeoJSON context |

### Transport Modes

| Transport | Use case |
|-----------|----------|
| stdio | Cursor, Claude Desktop, local scripts |
| sse | Placeholder in current CLI; reserved for future remote clients |

---

## Known Limitations

- `citysense index build` currently indexes through the OSM connector path.
- SSE transport is not a fully running server yet (`serve --transport sse` is a placeholder output).
- Pilot config modules currently shipped in code are `az` and `fi`.
- MCP server currently exposes one tool: `query_spatial_context`.

---

## Pilot Countries

| Country | Module Key | National CRS | Primary City |
|---------|------------|--------------|--------------|
| Azerbaijan | az | EPSG:32638 | Baku |
| Finland | fi | EPSG:3067 | Helsinki |

Planned pilot profiles (not yet shipped as config modules): Sweden (`se`), Denmark (`dk`), Norway (`no`).

### Pilot Configuration Attributes

| Attribute | Description |
|-----------|-------------|
| country | ISO2 code |
| language | IETF BCP 47 tag |
| national_crs | EPSG string |
| default_cities | City name to BBox mapping |
| connector_priority | Ordered connector IDs |
| wuf13_primary_dimensions | WUF13 dimension tags |
| data_gaps | Known gaps and fallback strategies |
| informality_heuristic | SAR/spectral heuristic for tenure |

---

## Mathematical Foundations

### Sentinel-2 Band Reference

All spectral indices are computed from Sentinel-2 L2A surface reflectance bands.

| Band ID | Centre Wavelength (nm) | Resolution (m) |
|---------|------------------------|----------------|
| B02 | 490 (Blue) | 10 |
| B03 | 560 (Green) | 10 |
| B04 | 665 (Red) | 10 |
| B08 | 842 (NIR broad) | 10 |
| B11 | 1610 (SWIR-1) | 20 |
| B12 | 2190 (SWIR-2) | 20 |

### Spectral Indices

#### NDVI (Normalized Difference Vegetation Index)

$$\mathrm{NDVI} = \frac{\rho_{\mathrm{NIR}} - \rho_{\mathrm{Red}}}{\rho_{\mathrm{NIR}} + \rho_{\mathrm{Red}}} = \frac{B_{08} - B_{04}}{B_{08} + B_{04}}$$

Range: $[-1, +1]$. Urban green: $> 0.3$. Built-up: $< 0.1$.

#### NDWI (McFeeters 1996)

$$\mathrm{NDWI} = \frac{B_{03} - B_{08}}{B_{03} + B_{08}}$$

Open water: $> 0.0$.

#### NDBI (Zha et al. 2003)

$$\mathrm{NDBI} = \frac{B_{11} - B_{08}}{B_{11} + B_{08}}$$

Built-up: $> 0.0$.

#### EVI (Huete et al. 2002)

$$\mathrm{EVI} = 2.5 \cdot \frac{B_{08} - B_{04}}{B_{08} + 6 \cdot B_{04} - 7.5 \cdot B_{02} + 1}$$

#### MNDWI (Modified NDWI)

$$\mathrm{MNDWI} = \frac{B_{03} - B_{11}}{B_{03} + B_{11}}$$

#### BSI (Rikimaru et al. 2002)

$$\mathrm{BSI} = \frac{(B_{11} + B_{04}) - (B_{08} + B_{02})}{(B_{11} + B_{04}) + (B_{08} + B_{02})}$$

### Reciprocal Rank Fusion

$$\mathrm{RRF}(d) = \sum_{R \in \{R_{\mathrm{dense}}, R_{\mathrm{sparse}}\}} \frac{1}{k + \mathrm{rank}_R(d)}$$

Default: $k = 60$.

### Cross-Encoder Reranking

$$s_i = \mathrm{CrossEncoder}(q, c_i)$$

### Urban Resilience Composite Score

$$\mathrm{URCS}(c) = \sum_{d \in D} w_d \cdot R_d(c)$$

where $D = \{\mathrm{physical}, \mathrm{climate}, \mathrm{social}, \mathrm{infrastructure}\}$.

| Dimension | Weight $w_d$ |
|-----------|--------------|
| Physical | 0.30 |
| Climate | 0.30 |
| Social | 0.20 |
| Infrastructure | 0.20 |

#### Physical Resilience Sub-dimension

$$R_{\mathrm{physical}} = \alpha_s \cdot s_{\mathrm{condition}} + \alpha_a \cdot (1 - a_{\mathrm{norm}}) + \alpha_{\mathrm{SAR}} \cdot (1 - I_{\mathrm{informal}})$$

Default: $\alpha_s = 0.4$, $\alpha_a = 0.35$, $\alpha_{\text{SAR}} = 0.25$.

### Segregation Indices

#### Dissimilarity Index

$$D = \frac{1}{2} \sum_{i=1}^{n} \left| \frac{g_i}{G} - \frac{m_i}{M} \right|$$

#### Isolation Index

$$P^* = \sum_{i=1}^{n} \left[ \frac{g_i}{G} \cdot \frac{g_i}{t_i} \right]$$

### Transit Accessibility (SDG 11.2.1)

$$A(c) = \sum_{s \in S(c, r)} f(s) \cdot e^{-\lambda \cdot d(c, s)}$$

Default: $r = 800$ m, $\lambda = 0.003$.

### Land Consumption Rate (SDG 11.3.1)

$$\mathrm{SDG}_{11.3.1} = \frac{\mathrm{LCR}}{\mathrm{PGR}}$$

$$\mathrm{LCR} = \frac{\ln(U_{\mathrm{land}}(t_1) / U_{\mathrm{land}}(t_0))}{t_1 - t_0}$$

$$\mathrm{PGR} = \frac{\ln(P(t_1) / P(t_0))}{t_1 - t_0}$$

Sustainable urban growth: ratio approximately 1. Ratio $> 1$: land consumption outpacing population growth. Ratio $< 1$: increasing density.

### Formula Summary Table

| Formula | Parameters | Default |
|---------|------------|---------|
| RRF | k | 60 |
| Transit accessibility | r (radius), lambda (decay) | 800 m, 0.003 |
| URCS physical | alpha_s, alpha_a, alpha_SAR | 0.4, 0.35, 0.25 |
| URCS dimensions | w_physical, w_climate, w_social, w_infrastructure | 0.30, 0.30, 0.20, 0.20 |

---

## API Summary

### Intent Parsing

```python
from citysense.rag.intent import parse_intent, SpatialIntent

intent: SpatialIntent = parse_intent(
    "social housing zones within 1 km of metro stations in Helsinki"
)
# intent.entity_types, intent.spatial_relations, intent.city_scope, ...
```

### Spectral Indices

```python
from citysense.imagery.satellite.indices import compute_index, compute_ndvi

# From band dict (B02, B03, B04, B08, B11)
ndvi_array = compute_index("NDVI", bands)
ndwi_array = compute_index("NDWI", bands)
```

### Urban Resilience

```python
from citysense.climate.resilience import compute_urcs, compute_physical_resilience

urcs = compute_urcs(physical=0.7, climate=0.6, social=0.5, infrastructure=0.8)
physical = compute_physical_resilience(
    street_condition=0.8, building_age_norm=0.3, informality_score=0.1
)
```

### SDG 11 Indicators

```python
from citysense.urban.sdg11 import compute_sdg_1131, compute_land_consumption_rate

lcr = compute_land_consumption_rate(
    urban_land_t0_km2=100, urban_land_t1_km2=120, years=10
)
ratio = compute_sdg_1131(
    urban_land_t0_km2=100, urban_land_t1_km2=120,
    pop_t0=1e6, pop_t1=1.2e6, years=10
)
```

### Pilot Configuration

```python
from citysense.pilot.az import AZ_CONFIG
from citysense.pilot.fi import FI_CONFIG

config = FI_CONFIG
print(config.country, config.national_crs, config.default_cities)
```

---

## Data Sources and Connectors

| Connector | Data Type | API |
|-----------|-----------|-----|
| OSM | Vector (buildings, roads, land use) | Overpass API |
| Sentinel-2 | Multispectral imagery | Copernicus Data Space, Sentinel Hub |
| Mapillary | Street-level imagery | Mapillary API v4 |
| KartaView | Street-level imagery | KartaView REST API |
| National registers | Cadastral, tenure | Country-specific |

Current CLI indexing path uses OSM. Other connectors are available as modules and are being wired into end-to-end CLI flows.

### Connector Priority

Pilot configurations define `connector_priority` to resolve conflicts when multiple sources provide overlapping data.

---

## WUF13 Alignment

The 13th World Urban Forum (WUF13) dialogue dimensions inform CitySense pilot configurations and indicator coverage.

### WUF13 Dialogue Dimensions

| Dimension | Description | CitySense Coverage |
|-----------|-------------|-------------------|
| Adequate housing | Access to safe, affordable housing | Housing zone analysis, tenure heuristics |
| Urban planning | Land use, zoning, spatial planning | OSM land use, pilot city schemas |
| Climate action | Resilience, adaptation, mitigation | URCS, spectral indices, flood/heat risk |
| Urban economy | Employment, economic opportunity | Transit accessibility, service proximity |
| Urban ecology | Green space, biodiversity | NDVI, NDWI, built-up indices |
| Urban governance | Participation, transparency | Data standards, open schemas |
| Urban finance | Revenue, expenditure, investment | Indicator framework for fiscal analysis |

### Pilot-Specific Data Gaps

| Country | Known Gaps | Fallback Strategy |
|---------|------------|-------------------|
| Azerbaijan | Peri-urban tenure | SAR texture + NDBI heuristic for informality |
| Finland | Informal settlements | Not applicable; use tenure from registers |
| Planned profiles (se, dk, no) | National profile tuning in progress | Add profile-specific data-gap maps during rollout |

---

## SpatialIntent Structure

The `SpatialIntent` dataclass captures parsed query slots from natural language input.

| Attribute | Type | Description |
|-----------|------|-------------|
| entity_types | tuple[str, ...] | OSM-style feature types (e.g. bus_stop, railway_station) |
| spatial_relations | tuple[str, ...] | Relations (e.g. near, within_500m) |
| attributes | dict[str, str] | Attribute filters (e.g. resilience: low) |
| country_scope | str \| None | ISO2 country code |
| city_scope | str \| None | City name |
| bbox | BBox \| None | Resolved bounding box |
| wuf13_dimension | str \| None | WUF13 dialogue dimension |
| sdg_indicator | str \| None | SDG indicator code (e.g. 11.2.1) |

---

## H3 Spatial Index

CitySense uses Uber H3 for hexagonal spatial indexing. Benefits include uniform cell size, hierarchical resolution, and efficient neighborhood queries.

### Resolution Reference

| Resolution | Avg hexagon area (km^2) | Use case |
|------------|------------------------|----------|
| 5 | 252.9 | City-scale analysis |
| 6 | 36.1 | District-scale |
| 7 | 5.2 | Neighborhood-scale |
| 8 | 0.74 | Block-scale |
| 9 | 0.11 | Building-scale |

### Antimeridian Handling

H3 cells crossing the antimeridian require special handling. CitySense pre-filters queries to avoid invalid geometries.

---

## Dependencies

### Core Dependencies

| Package | Version | Purpose |
|---------|---------|---------|
| shapely | >=2.1.2, <3.0 | Geometry operations |
| geopandas | >=1.1.2, <2.0 | Geospatial DataFrames |
| pyproj | >=3.7.1, <4.0 | Coordinate transformations |
| pyogrio | >=0.10.0 | Vector I/O |
| numpy | >=2.2.0, <3.0 | Numerical arrays |
| pandas | >=2.3.0, <4.0 | Tabular data |
| h3 | >=4.1.0, <5.0 | Hexagonal spatial index |
| rasterio | >=1.4.3, <2.0 | Raster I/O |
| xarray | >=2023.1.0 | Multidimensional arrays |
| pydantic | >=2.12.0, <3.0 | Data validation |
| pydantic-settings | >=2.7.0, <3.0 | Configuration |
| qdrant-client | >=1.17.0, <2.0 | Vector store client |
| fastembed | >=0.4.2, <1.0 | Embedding models |
| rank-bm25 | >=0.2.2 | BM25 sparse retrieval |
| litellm | >=1.57.0, <2.0 | LLM abstraction |
| mcp | >=1.4.0, <2.0 | Model Context Protocol |
| pystac-client | >=0.8.5, <1.0 | STAC catalog access |
| rio-cogeo | >=5.4.0, <8.0 | Cloud-optimized GeoTIFF |
| httpx | >=0.28.0, <1.0 | HTTP client |
| Pillow | >=11.1.0, <13.0 | Image processing |
| APScheduler | >=3.11.0, <4.0 | Task scheduling |
| structlog | >=25.1.0, <26.0 | Structured logging |
| typer | >=0.15.0, <1.0 | CLI framework |

### Optional Dependencies

| Extra | Packages | Purpose |
|-------|----------|---------|
| clip | transformers, torch | CLIP ViT-B/32 for street imagery |
| sentinelhub | sentinelhub | Sentinel Hub Process API |
| dev | ruff, mypy, pytest, mkdocs, pre-commit | Development tooling |

---

## Data Flow

### Index Build Flow

```text
City + country input
  |
  v
OSMConnector.fetch(bbox)
  |
  v
GeoDataFrame normalization
  |
  v
H3 assignment + chunk text
  |
  v
Embedding generation
  |
  v
Qdrant upsert
```

### Query Flow

```text
Natural-language query
  |
  v
parse_intent() -> SpatialIntent
  |
  v
embed_texts(query)
  |
  v
hybrid_search(Qdrant + BM25)
  |
  v
rerank(top_k)
  |
  v
assemble_context()
```

---

## Troubleshooting

| Issue | Cause | Resolution |
|-------|-------|------------|
| Qdrant connection refused | Qdrant not running | Start Qdrant: `docker run -p 6333:6333 qdrant/qdrant` |
| Index empty after build | Connector returned no data | Check city name, pilot config, OSM coverage |
| Mapillary 401 | Invalid or missing token | Set MAPILLARY_ACCESS_TOKEN |
| CDSE auth failure | Invalid credentials | Set CDSE_CLIENT_ID, CDSE_CLIENT_SECRET |
| CRS transform error | Mismatched EPSG | Verify pilot national_crs |
| H3 antimeridian error | Query crosses date line | Use bbox that does not span antimeridian |

---

## Glossary

| Term | Definition |
|------|------------|
| RAG | Retrieval-Augmented Generation; augmenting LLM context with retrieved documents |
| MCP | Model Context Protocol; standard for AI tools and context |
| H3 | Uber hexagonal hierarchical spatial index |
| CRS | Coordinate Reference System |
| URCS | Urban Resilience Composite Score |
| LCR | Land Consumption Rate (SDG 11.3.1 numerator) |
| PGR | Population Growth Rate (SDG 11.3.1 denominator) |
| RRF | Reciprocal Rank Fusion |
| NDVI | Normalized Difference Vegetation Index |
| NDWI | Normalized Difference Water Index |
| NDBI | Normalized Difference Built-up Index |
| WUF13 | 13th World Urban Forum |
| SDG 11 | UN Sustainable Development Goal 11 (Sustainable Cities) |

---

## Frequently Asked Questions

### Is CitySense suitable for production use?

CitySense is in Alpha (Development Status 3). Use for research, prototyping, and pilot deployments. Production hardening is ongoing.

### Which embedding model is used?

Default: BAAI/bge-m3. Configurable via CITYSENSE_EMBEDDING_MODEL.

### Does CitySense support private repositories?

The MCP server and CLI work with any data source. Vector store (Qdrant) can be self-hosted. No data is sent to external services except configured APIs (Mapillary, CDSE, etc.).

### How is coverage computed?

Coverage excludes connectors and modules under active development. Run `pytest tests/unit --cov=citysense --cov-report=term-missing` for current metrics.

### Can I add a new pilot country?

Yes. Add a new `PilotConfig` module under `citysense.pilot`, expose it in package imports, and extend CLI validation logic for country codes. See CONTRIBUTING.md.

---

## Version History

| Version | Date | Highlights |
|---------|------|------------|
| 0.2.1 | 2026-02 | Current alpha release; core RAG pipeline, FastMCP server, and pilot configs for AZ/FI |
| 0.2.0 | 2026-02-28 | Initial WUF13-aligned specification baseline |
| Unreleased | - | Additional pilot profiles, richer MCP tool surface, expanded connector wiring |

---

## Development

### Setup

```bash
git clone https://github.com/olaflaitinen/citysense.git
cd citysense
pip install -e ".[dev,clip]"
pre-commit install
```

### Linting and Type Checking

```bash
ruff check src tests
ruff format --check src tests
mypy src/citysense
```

### Tests

```bash
pytest tests/unit -v
pytest tests/unit -v --cov=citysense --cov-report=term-missing
```

### Documentation

```bash
mkdocs serve
```

### Priority Contribution Areas

| Area | Description |
|------|-------------|
| Country connectors | Additional WUF13-relevant cities and national data sources |
| Non-Latin script | Arabic, Cyrillic handling for Azerbaijan and Central Asia |
| Informal settlement detection | Model improvements for tenure heuristics |
| Climate adaptation | Document parsers for national plans |

### Python Version Compatibility

| Python | Status |
|--------|--------|
| 3.12 | Supported, tested in CI |
| 3.13 | Supported, tested in CI |
| 3.11 | Not supported (requires 3.12+) |

### Commit Message Format

| Type | Version Bump | Example |
|------|---------------|---------|
| feat: | Minor | feat(imagery): add Sentinel-3 LST connector |
| fix: | Patch | fix(rag): correct H3 pre-filter for antimeridian |
| feat!: | Major | feat!: remove deprecated search() method |
| docs:, chore:, test: | None | docs: add Baku pilot tutorial |

---

## Security Considerations

| Concern | Mitigation |
|--------|------------|
| API tokens | Store in environment variables or secrets; never commit |
| Qdrant | Run locally or in private network; no default auth |
| Data provenance | All connectors document source and license |
| Dependency audit | Dependabot enabled; run `pip audit` periodically |

---

## Performance Notes

| Operation | Typical scale | Notes |
|-----------|---------------|-------|
| Index build (OSM, city) | 10k-100k features | Depends on city size, H3 resolution |
| Query latency | 100-500 ms | Dense + sparse + RRF; reranker adds ~50 ms |
| Embedding | BAAI/bge-m3 | ~50 docs/s on CPU; GPU accelerates |
| Qdrant | Local | Sub-10 ms for vector search at city scale |

---

## References

### Spectral Indices

- McFeeters, S. K. (1996). The use of the Normalized Difference Water Index (NDWI) in the delineation of open water features. International Journal of Remote Sensing, 17(7), 1425-1432.
- Zha, Y., Gao, J., & Ni, S. (2003). Use of normalized difference built-up index in automatically mapping urban areas from TM imagery. International Journal of Remote Sensing, 24(3), 583-594.
- Huete, A., et al. (2002). Overview of the radiometric and biophysical performance of the MODIS vegetation indices. Remote Sensing of Environment, 83(1-2), 195-213.
- Rikimaru, A., Roy, P. S., & Miyatake, S. (2002). Tropical forest cover density mapping. Tropical Ecology, 43(1), 39-47.

### SDG and Urban Indicators

- UN-Habitat. (2020). SDG Indicator 11.3.1 - Land consumption rate. United Nations.
- UN-Habitat. (2020). SDG Indicator 11.2.1 - Proportion of population with convenient access to public transport. United Nations.

### Retrieval

- Cormack, G. V., Clarke, C. L., & Buettcher, S. (2009). Reciprocal rank fusion outperforms condorcet and individual rank learning methods. SIGIR 2009.

### Citation

If you use CitySense in academic work, please cite:

```
CitySense: Geospatial RAG and MCP Server for Urban AI Development.
Specification v0.2.1. WUF13 Aligned. 2026.
https://github.com/olaflaitinen/citysense
```

### Spectral Index Interpretation Ranges

| Index | Low | Medium | High | Interpretation |
|-------|-----|--------|------|-----------------|
| NDVI | < 0.1 | 0.1-0.3 | > 0.3 | Vegetation density |
| NDWI | < 0 | 0 | > 0 | Open water presence |
| NDBI | < 0 | 0 | > 0 | Built-up intensity |
| EVI | < 0.2 | 0.2-0.4 | > 0.4 | Enhanced vegetation |
| BSI | < 0 | 0 | > 0 | Bare soil / impervious |

---

## License

EUPL-1.2. See [LICENSE](LICENSE).

---

## Links

| Resource | URL |
|----------|-----|
| Documentation | [citysense.readthedocs.io](https://citysense.readthedocs.io) |
| Repository | [github.com/olaflaitinen/citysense](https://github.com/olaflaitinen/citysense) |
| Issues | [github.com/olaflaitinen/citysense/issues](https://github.com/olaflaitinen/citysense/issues) |
| Changelog | [CHANGELOG.md](CHANGELOG.md) |
| Contributing | [CONTRIBUTING.md](CONTRIBUTING.md) |
| Security | [SECURITY.md](SECURITY.md) |

---

## Acknowledgments

CitySense builds on open standards and community data: OpenStreetMap contributors, Copernicus Programme, Mapillary, KartaView, Qdrant, and the Model Context Protocol initiative. Pilot country configurations align with national spatial data infrastructures and WUF13 dialogue priorities.

